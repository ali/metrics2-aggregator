#!/usr/bin/ruby

require "../lib/aggregator"

host = "localhost"
port = "5984"
@database = "allthefucks"
@db = Aggregator::CouchDB.new(host, port)
set = Time.now

# Example raw input data
# hyfi     pts/11       nomad.ccs.neu.ed Fri Feb  8 18:32:59 2013   still logged in
# hyfi     pts/0        c-24-62-61-212.h Fri Feb  8 01:54:57 2013 - Fri Feb  8 04:33:51 2013  (02:38)

def get_last(set)
  last = (`last -Fw | grep -v root | head --lines=-2`).split("\n")
  hostname = `hostname`.strip.downcase.intern
  os = `uname`.strip.downcase.intern

  last.each do |line|
    # Parse it
    session = Aggregator::Parser.parse_last_line(line, hostname, os, set)

    # Send it!
    unless session.ended and session.ended < set - 10*60
      @db.post("/"+@database, session.to_json)
    end
  end
end

get_last set
